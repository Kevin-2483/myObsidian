<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仓库管理系统</title>
    <!-- 引入第一个CSS文件 -->
    <link rel="stylesheet" href="./github-markdown.css">
    <!-- 引入第二个CSS文件 -->
    <link rel="stylesheet" href="./github-markdown-light.css">
</head>

<body class="markdown-body-light markdown-body">
<h1 id="仓库管理系统">仓库管理系统</h1>
<h2 id="特性需求">特性需求</h2>
<h3 id="安全性">安全性</h3>
<p>安全性需要后端基础设施完备且前后端配合,并且合理部署
详细说明见后端重点</p>
<h3 id="易于部署">易于部署</h3>
<p>目标是通过单一二进制文件在任何主流平台简单完成部署.包括嵌入式数据库,数据迁移,管理员用户生成等初始化流程自动化完成,通过环境变量方便配置,单一指令快速启动</p>
<h3 id="跨平台">跨平台</h3>
<p>在开发中我主要使用linux环境,x86-64架构,但通过在不同平台和架构的构建来实现跨平台和多架构的兼容.这也使得程序的各个部分集成程度很高</p>
<h2 id="应用程序架构">应用程序架构</h2>
<ul>
<li>前端使用React jsx</li>
<li>后端使用Rust</li>
<li>采用嵌入式数据库,Diesel 与 SQLite 结合</li>
<li>由Rust提供静态文件服务,使得前后端分离设计但是部署时统一</li>
<li>web框架由Rocket提供</li>
<li>去中心化的仓库管理系统,各个仓库节点独立运行并相互协作</li>
</ul>
<h2 id="功能需求">功能需求</h2>
<ul>
<li>入库</li>
<li>出库</li>
<li>货品查询(多仓库联动)</li>
<li>货品分类</li>
<li>多管理员</li>
<li>不同仓库间货品调度(通过不同服务端联动实现,一个服务对应一个仓库)</li>
</ul>
<h1 id="后端">后端</h1>
<h2 id="依赖">依赖</h2>
<div class="sourceCode" id="cb1"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[package]</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;app1&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">&quot;2021&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="dt">diesel</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^2.1&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;sqlite&quot;</span><span class="op">,</span> <span class="st">&quot;r2d2&quot;</span><span class="op">,</span> <span class="st">&quot;chrono&quot;</span><span class="op">] }</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="dt">dotenvy</span> <span class="op">=</span> <span class="st">&quot;^0.15&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="dt">serde</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^1.0&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;derive&quot;</span><span class="op">] }</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="dt">serde_json</span> <span class="op">=</span> <span class="st">&quot;^1.0&quot;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="dt">chrono</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^0.4&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;serde&quot;</span><span class="op">] }</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="dt">rocket</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^0.5&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;json&quot;</span><span class="op">] }</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="dt">rocket_sync_db_pools</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^0.1&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;diesel_sqlite_pool&quot;</span><span class="op">] }</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="dt">rocket_cors</span> <span class="op">=</span> <span class="st">&quot;0.6.0&quot;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># rusqlite = &quot;^0.31&quot;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="dt">rand</span> <span class="op">=</span> <span class="st">&quot;^0.8&quot;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="dt">libsqlite3-sys</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^0.28&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;bundled&quot;</span><span class="op">] }</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="dt">async-std</span> <span class="op">=</span> <span class="st">&quot;^1&quot;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="dt">futures</span> <span class="op">=</span> <span class="st">&quot;^0.3&quot;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="dt">uuid</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;1&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;v4&quot;</span><span class="op">] }</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="dt">env_logger</span> <span class="op">=</span> <span class="st">&quot;^0.11&quot;</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="dt">libp2p</span> <span class="op">=</span> <span class="st">&quot;0.46.1&quot;</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="dt">tokio</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;1.19.2&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;full&quot;</span><span class="op">] }</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="dt">tokio-util</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;0.7.11&quot;</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;compat&quot;</span><span class="op">,</span> <span class="st">&quot;io&quot;</span><span class="op">] }</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="dt">log</span> <span class="op">=</span> <span class="st">&quot;^0.4&quot;</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="dt">log4rs</span> <span class="op">=</span> <span class="st">&quot;^1.3&quot;</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="dt">serde_yaml</span> <span class="op">=</span> <span class="st">&quot;0.9.34+deprecated&quot;</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="dt">jsonwebtoken</span> <span class="op">=</span> <span class="st">&quot;^9.3.0&quot;</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="dt">async-trait</span> <span class="op">=</span> <span class="st">&quot;0.1.80&quot;</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="dt">base64</span> <span class="op">=</span> <span class="st">&quot;0.22.1&quot;</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies.rocket_dyn_templates]</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;^0.2&quot;</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="dt">features</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;handlebars&quot;</span><span class="op">]</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies.rocket_contrib]</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;^0.4&quot;</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="dt">features</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;json&quot;</span><span class="op">]</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies.diesel_migrations]</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;^2.2&quot;</span></span></code></pre></div>
<blockquote>
<p>截止至目前(24.5.26)依赖更新情况,以<a
href="https://crates.io">crates.io</a>为参考</p>
</blockquote>
<table>
<colgroup>
<col style="width: 89%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="header">
<th>依赖</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://crates.io/crates/diesel">diesel</a></td>
<td>v2.1.6</td>
</tr>
<tr class="even">
<td><a href="https://crates.io/crates/dotenvy">dotenvy</a></td>
<td>v0.15.7</td>
</tr>
<tr class="odd">
<td><a href="https://crates.io/crates/serde">serde</a></td>
<td>v1.0.203</td>
</tr>
<tr class="even">
<td><a href="https://crates.io/crates/serde_json">serde_json</a></td>
<td>v1.0.117</td>
</tr>
<tr class="odd">
<td><a href="https://crates.io/crates/chrono">chrono</a></td>
<td>v0.4.38</td>
</tr>
<tr class="even">
<td><a href="https://crates.io/crates/rocket">rocket</a></td>
<td>v0.5.1</td>
</tr>
<tr class="odd">
<td><a
href="https://crates.io/crates/rocket_sync_db_pools">rocket_sync_db_pools</a></td>
<td>v0.1.0</td>
</tr>
<tr class="even">
<td><a href="https://crates.io/crates/rand">rand</a></td>
<td>v0.8.5</td>
</tr>
<tr class="odd">
<td><a
href="https://crates.io/crates/libsqlite3-sys">libsqlite3-sys</a></td>
<td>v0.28.0</td>
</tr>
<tr class="even">
<td><a href="https://crates.io/crates/log">log</a></td>
<td>v0.4.21</td>
</tr>
<tr class="odd">
<td><a href="https://crates.io/crates/env_logger">env_logger</a></td>
<td>v0.11.3</td>
</tr>
<tr class="even">
<td><a
href="https://crates.io/crates/rocket_dyn_templates">rocket_dyn_templates</a></td>
<td>v0.2.0</td>
</tr>
<tr class="odd">
<td><a
href="https://crates.io/crates/rocket_contrib">rocket_contrib</a></td>
<td>v0.4.11</td>
</tr>
<tr class="even">
<td><a
href="https://crates.io/crates/diesel_migrations">diesel_migrations</a></td>
<td>v2.2.0</td>
</tr>
</tbody>
</table>
<p><em><a href="依赖">依赖介绍</a></em></p>
<h2
id="在rust项目中使用diesel来管理这些表和数据操作">在Rust项目中使用Diesel来管理这些表和数据操作</h2>
<h3 id="安装diesel-cli">安装Diesel CLI</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install diesel_cli <span class="at">--no-default-features</span> <span class="at">--features</span> sqlite</span></code></pre></div>
<h3 id="初始化diesel">初始化Diesel</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">diesel</span> setup</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">diesel</span> migration generate create_warehouse_schema</span></code></pre></div>
<h3 id="diesel数据库迁移文件">Diesel数据库迁移文件</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode up.sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 货品表</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> products (</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    description TEXT,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    category_id <span class="dt">INTEGER</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (category_id) <span class="kw">REFERENCES</span> categories(<span class="kw">id</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 分类表</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> categories (</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    description TEXT</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- 库存表</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> inventory (</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    product_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    warehouse_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    quantity <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (product_id) <span class="kw">REFERENCES</span> products(<span class="kw">id</span>),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (warehouse_id) <span class="kw">REFERENCES</span> warehouses(<span class="kw">id</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- 仓库表</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> warehouses (</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    name TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    location TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">-- 仓库调度表</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> warehouse_transfers (</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    product_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    from_warehouse_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    to_warehouse_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    quantity <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    transfer_date <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (product_id) <span class="kw">REFERENCES</span> products(<span class="kw">id</span>),</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (from_warehouse_id) <span class="kw">REFERENCES</span> warehouses(<span class="kw">id</span>),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (to_warehouse_id) <span class="kw">REFERENCES</span> warehouses(<span class="kw">id</span>)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">-- 管理员表</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> administrators (</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTOINCREMENT,</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    username TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">password</span> TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode down.sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- This file should undo anything in `up.sql`</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> administrators;</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> warehouse_transfers;</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> warehouses;</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> inventory;</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> categories;</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> products;</span></code></pre></div>
<blockquote>
<p>此时可以手动运行迁移 <code>diesel migration run</code>.</p>
</blockquote>
<h3 id="后端实现">后端实现</h3>
<h4 id="后端重点">后端重点</h4>
<p>重点应放在建立完备的访问安全性基础设施和完备合理的错误处理上.</p>
<h5 id="安全性-1">安全性</h5>
<p>对于安全性,处理保证http访问的安全,认证系统的完备,还应考虑到仓库管理系统的实际应用情况.
###### 网络访问的安全性</p>
<p>对于网络访问的安全性,p2p通信应使用加密,和数字签名,对于http接口,使用rocket部署嵌入react应用,并配置前端代理来保证没有跨域资源访问,这样才能保证前后端通信使用http协议的情况下相对安全.对于前端的访问,在实际生产环境应使用反向代理工具来实现https加密和证书颁发.
对于cookie应使用完好的密钥加密,并启用httponly来阻止脚本注入攻击.</p>
<h6
id="参考仓库管理系统的实际应用情况未完成">参考仓库管理系统的实际应用情况(未完成)</h6>
<p>根据仓库管理系统的实际应用情况,对超级管理员的行为应有限制,对于数据库的读写应首先通过p2p网络的消息队列发送读写请求,在其他节点完成回复和日志记录后对数据库记录进行更改.管理员的行为应被限制在不能完全删除有关记录而是使用标记来确定记录状态.</p>
<h5 id="错误处理">错误处理</h5>
<p>对于错误处理,作为网络服务,出现错误,如果严重程度不高应优先保证服务运行,因此不能随意出发panic来终止进程.对于错误要有完备的状态恢复和信息说明来对用户进行说明,同时服务端应有完善的日志记录</p>
<h4 id="定义对象关系映射结构体">定义对象关系映射结构体</h4>
<div class="sourceCode" id="cb6"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/models.rs</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">super</span><span class="pp">::schema::</span><span class="op">*;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">serde::</span><span class="op">{</span>Serialize<span class="op">,</span> Deserialize<span class="op">};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::</span><span class="op">{</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Insertable<span class="op">};</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::prelude::</span><span class="op">*;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">// use diesel::sql_types::Integer;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chrono::</span>NaiveDateTime<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="op">,</span> Associations<span class="at">)]</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> products<span class="at">)]</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>belongs_to<span class="at">(</span>Category<span class="at">))]</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> <span class="bu">Product</span> <span class="op">{</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> description<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> category_id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="op">,</span> Insertable<span class="at">)]</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> categories<span class="at">)]</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Category <span class="op">{</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> description<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Selectable<span class="op">,</span> Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="op">,</span> Associations<span class="at">)]</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> inventory<span class="at">)]</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>belongs_to<span class="at">(</span><span class="bu">Product</span><span class="at">))]</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>belongs_to<span class="at">(</span>Warehouse<span class="at">))]</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Inventory <span class="op">{</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> product_id<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> warehouse_id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> quantity<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> deleted<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="op">,</span> Insertable<span class="at">)]</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> warehouses<span class="at">)]</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Warehouse <span class="op">{</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> localkey<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> location<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="op">,</span> Associations<span class="at">)]</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> warehouse_transfers<span class="at">)]</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>belongs_to<span class="at">(</span><span class="bu">Product</span><span class="at">))]</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>belongs_to<span class="at">(</span>Warehouse<span class="op">,</span> foreign_key <span class="op">=</span> from_warehouse_id<span class="at">))]</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> WarehouseTransfer <span class="op">{</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> product_id<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> from_warehouse_id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> to_warehouse_id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> quantity<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> transfer_date<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Identifiable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> administrators<span class="at">)]</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Administrator <span class="op">{</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> username<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> password<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> superuser<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="定义数据库模式">定义数据库模式</h4>
<div class="sourceCode" id="cb7"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/schema.rs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @generated automatically by Diesel CLI.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    administrators (id) <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        username <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        password <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        superuser <span class="op">-&gt;</span> Bool<span class="op">,</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        created_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        updated_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    categories (id) <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        name <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        description <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Text<span class="op">&gt;,</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    inventory (id) <span class="op">{</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        product_id <span class="op">-&gt;</span> Integer<span class="op">,</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        warehouse_id <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        quantity <span class="op">-&gt;</span> Integer<span class="op">,</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        deleted <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        created_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        updated_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    products (id) <span class="op">{</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        name <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        description <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Text<span class="op">&gt;,</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        category_id <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Integer<span class="op">&gt;,</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        created_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>        updated_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>    warehouse_transfers (id) <span class="op">{</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Integer<span class="op">,</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        product_id <span class="op">-&gt;</span> Integer<span class="op">,</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>        from_warehouse_id <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>        to_warehouse_id <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        quantity <span class="op">-&gt;</span> Integer<span class="op">,</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        transfer_date <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>        created_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>        updated_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::table!</span> <span class="op">{</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    warehouses (id) <span class="op">{</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>        id <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>        localkey <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Text<span class="op">&gt;,</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>        name <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>        location <span class="op">-&gt;</span> Text<span class="op">,</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>        created_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>        updated_at <span class="op">-&gt;</span> Nullable<span class="op">&lt;</span>Timestamp<span class="op">&gt;,</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::joinable!</span>(inventory <span class="op">-&gt;</span> products (product_id))<span class="op">;</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::joinable!</span>(inventory <span class="op">-&gt;</span> warehouses (warehouse_id))<span class="op">;</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::joinable!</span>(products <span class="op">-&gt;</span> categories (category_id))<span class="op">;</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::joinable!</span>(warehouse_transfers <span class="op">-&gt;</span> products (product_id))<span class="op">;</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a><span class="pp">diesel::allow_tables_to_appear_in_same_query!</span>(</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>    administrators<span class="op">,</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">,</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>    inventory<span class="op">,</span></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>    products<span class="op">,</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>    warehouse_transfers<span class="op">,</span></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>    warehouses<span class="op">,</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<h4 id="引用模块和插件">引用模块和插件</h4>
<div class="sourceCode" id="cb8"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">//src/main.rs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>macro_use<span class="at">]</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">crate</span> rocket<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">crate</span> base64<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">// use rocket::fairing::AdHoc;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::fairing::</span><span class="op">{</span>Fairing<span class="op">,</span> Info<span class="op">,</span> Kind<span class="op">};</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::figment::</span><span class="op">{</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="pp">providers::</span><span class="op">{</span>Env<span class="op">,</span> Serialized<span class="op">},</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    Figment<span class="op">,</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::http::</span>Status<span class="op">;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::request::</span><span class="op">{</span>FromRequest<span class="op">,</span> Outcome<span class="op">};</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">// use rocket::request;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">// use rocket::response::status;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::http::</span>Method<span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::http::</span><span class="op">{</span>Cookie<span class="op">,</span> CookieJar<span class="op">};</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">// use rocket::response::status::Custom;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::serde::json::</span>Json<span class="op">;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::</span>Request<span class="op">;</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket::</span><span class="op">{</span>Build<span class="op">,</span> Config<span class="op">,</span> Rocket<span class="op">};</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket_cors::</span><span class="op">{</span>AllowedHeaders<span class="op">,</span> AllowedOrigins<span class="op">,</span> CorsOptions<span class="op">};</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rocket_sync_db_pools::</span><span class="op">{</span>database<span class="op">,</span> diesel<span class="op">};</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::models::</span><span class="op">*;</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::schema::</span><span class="op">*;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::dsl::</span>sql<span class="op">;</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::prelude::</span><span class="op">*;</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::sql_types::</span>Integer<span class="op">;</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::sql_types::</span>Nullable<span class="op">;</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel::sqlite::</span>SqliteConnection<span class="op">;</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">diesel_migrations::</span><span class="op">{</span>embed_migrations<span class="op">,</span> EmbeddedMigrations<span class="op">,</span> MigrationHarness<span class="op">};</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rand::distributions::</span>Alphanumeric<span class="op">;</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">rand::</span>Rng<span class="op">;</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::collections::</span>HashMap<span class="op">;</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::collections::</span>HashSet<span class="op">;</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::error::</span><span class="bu">Error</span><span class="op">;</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co">// use std::io::Cursor;</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::result::</span><span class="dt">Result</span> <span class="kw">as</span> StdResult<span class="op">;</span> <span class="co">// 为了避免名称冲突，使用别名</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>                                      <span class="co">// use std::time::Duration;</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::</span>env<span class="op">;</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::time::</span><span class="op">{</span>SystemTime<span class="op">,</span> <span class="cn">UNIX_EPOCH</span><span class="op">};</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="co">// use std::clone;</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chrono::</span>Local<span class="op">;</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chrono::</span>NaiveDateTime<span class="op">;</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chrono::</span>Utc<span class="op">;</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">serde::</span>Deserialize<span class="op">;</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">serde::</span>Serialize<span class="op">;</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="co">// use uuid::Uuid;</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::floodsub::</span><span class="op">{</span>Floodsub<span class="op">,</span> FloodsubEvent<span class="op">,</span> Topic<span class="op">};</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::floodsub;</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::futures::</span>StreamExt<span class="op">;</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::identity::</span><span class="op">{</span><span class="kw">self</span><span class="op">,</span> ed25519<span class="op">,</span> PublicKey<span class="op">};</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::identity::Keypair;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::kad::</span><span class="op">{</span><span class="pp">record::store::</span>MemoryStore<span class="op">,</span> Kademlia<span class="op">,</span> KademliaConfig<span class="op">,</span> KademliaEvent<span class="op">};</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::mdns::</span><span class="op">{</span>Mdns<span class="op">,</span> MdnsConfig<span class="op">,</span> MdnsEvent<span class="op">};</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::ping::</span><span class="op">{</span>Ping<span class="op">,</span> PingConfig<span class="op">,</span> PingEvent<span class="op">};</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::request_response::{</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a><span class="co">//     ProtocolName, RequestResponse, RequestResponseCodec, RequestResponseEvent,</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a><span class="co">//     RequestResponseMessage,</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a><span class="co">// };</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::swarm::</span><span class="op">{</span>Swarm<span class="op">,</span> SwarmBuilder<span class="op">,</span> SwarmEvent<span class="op">};</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::swarm::{</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a><span class="co">//     NetworkBehaviour, NetworkBehaviourEventProcess</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a><span class="co">// };</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">libp2p::</span><span class="op">{</span>development_transport<span class="op">,</span> Multiaddr<span class="op">,</span> NetworkBehaviour<span class="op">,</span> PeerId<span class="op">};</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> tokio<span class="op">;</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a><span class="co">// use tokio::io::{ AsyncBufReadExt, AsyncRead, AsyncReadExt, AsyncWrite, AsyncWriteExt};</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">tokio::</span>io<span class="op">;</span></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">tokio::</span>signal<span class="op">;</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">tokio::</span>task<span class="op">;</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">tokio_util::compat::</span>TokioAsyncReadCompatExt<span class="op">;</span></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a><span class="co">// use tokio_util::compat::FuturesAsyncReadCompatExt;</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::dns::DnsConfig;</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a><span class="co">// use libp2p::tcp::GenTcpConfig;</span></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log::</span>LevelFilter<span class="op">;</span></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log::</span><span class="op">{</span>error<span class="op">,</span> info<span class="op">,</span> warn<span class="op">};</span></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a><span class="co">// use log::debug;</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::append::console::</span>ConsoleAppender<span class="op">;</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::append::file::</span>FileAppender<span class="op">;</span></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::config::</span>Config <span class="kw">as</span> LogConfig<span class="op">;</span></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::config::</span><span class="op">{</span>Appender<span class="op">,</span> Root<span class="op">};</span></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::encode::pattern::</span>PatternEncoder<span class="op">;</span></span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">log4rs::</span>init_config<span class="op">;</span></span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">base64::</span><span class="op">{</span><span class="pp">engine::</span>general_purpose<span class="op">,</span> Engine <span class="kw">as</span> _<span class="op">};</span></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">futures::prelude::</span><span class="op">*;</span></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">jsonwebtoken::</span><span class="op">{</span>decode<span class="op">,</span> encode<span class="op">,</span> DecodingKey<span class="op">,</span> EncodingKey<span class="op">,</span> Header<span class="op">,</span> Validation<span class="op">};</span></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> models<span class="op">;</span></span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> schema<span class="op">;</span></span></code></pre></div>
<h4 id="实现trait">实现Trait</h4>
<pre><code>impl Claims {

    fn new(username: &amp;str) -&gt; Self {

        let now = SystemTime::now();

        let exp = now

            .duration_since(UNIX_EPOCH)

            .expect(&quot;Time went backwards&quot;)

            .as_secs()

            + 1800; // Token expires in 30 minutes

  

        Self {

            sub: username.to_owned(),

            exp: exp as usize,

        }

    }

}//cookieToken负载的实现,包含用户名和过期时间


impl From&lt;KademliaEvent&gt; for KMBehaviourEvent {

    fn from(event: KademliaEvent) -&gt; Self {

        KMBehaviourEvent::Kademlia(event)

    }

}//基于Kademlia协议的广域网网络发现的实现

  

impl From&lt;MdnsEvent&gt; for KMBehaviourEvent {

    fn from(event: MdnsEvent) -&gt; Self {

        KMBehaviourEvent::Mdns(event)

    }

}//基于mDNS协议的局域网网络发现的实现

  

impl From&lt;PingEvent&gt; for KMBehaviourEvent {

    fn from(event: PingEvent) -&gt; Self {

        KMBehaviourEvent::Ping(event)

    }

}//p2p网络节点之间ping行为的实现

  

impl From&lt;FloodsubEvent&gt; for KMBehaviourEvent {

    fn from(event: FloodsubEvent) -&gt; Self {

        KMBehaviourEvent::Floodsub(event)

    }

}//p2p网络节点之间消息发布和订阅行为的实现

  

#[async_trait]

impl&lt;&#39;r&gt; FromRequest&lt;&#39;r&gt; for JwtToken {

    type Error = ();

  

    async fn from_request(request: &amp;&#39;r Request&lt;&#39;_&gt;) -&gt; rocket::request::Outcome&lt;Self, Self::Error&gt; {

        let cookies: &amp;CookieJar&lt;&#39;_&gt; = request.cookies();

        if let Some(cookie) = cookies.get(&quot;token&quot;) {

            let token = cookie.value();

            match decode_token(token) {

                Some(username) =&gt; Outcome::Success(JwtToken(username)),

                None =&gt; Outcome::Error((Status::Unauthorized, ())),

            }

        } else {

            Outcome::Error((Status::Unauthorized, ()))

        }

    }

}//rocket获取cookie和token的实现</code></pre>
<blockquote>
<p>cookies获取必须是同域请求</p>
</blockquote>
<h4 id="定义行为等结构体">定义行为等结构体</h4>
<div class="sourceCode" id="cb10"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AdminInit<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="at">)]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> JwtToken(<span class="kw">pub</span> <span class="dt">String</span>)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Claims <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    sub<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    exp<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> CustomResponder <span class="op">{</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    status<span class="op">:</span> Status<span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    message<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>FromForm<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> LoginCredentials <span class="op">{</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    username<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    password<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>NetworkBehaviour<span class="at">)]</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>behaviour<span class="at">(</span>out_event <span class="op">=</span> <span class="st">&quot;KMBehaviourEvent&quot;</span><span class="at">)]</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> KMBehaviour <span class="op">{</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    kademlia<span class="op">:</span> Kademlia<span class="op">&lt;</span>MemoryStore<span class="op">&gt;,</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    mdns<span class="op">:</span> Mdns<span class="op">,</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    ping<span class="op">:</span> Ping<span class="op">,</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    floodsub<span class="op">:</span> Floodsub<span class="op">,</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> KMBehaviourEvent <span class="op">{</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    Kademlia(KademliaEvent)<span class="op">,</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    Mdns(MdnsEvent)<span class="op">,</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    Ping(PingEvent)<span class="op">,</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    Floodsub(FloodsubEvent)<span class="op">,</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>database<span class="at">(</span><span class="st">&quot;sqlite_db&quot;</span><span class="at">)]</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> DbConn(SqliteConnection)<span class="op">;</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>get<span class="at">(</span><span class="st">&quot;/&quot;</span><span class="at">)]</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> index() <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="ot">&#39;static</span> <span class="dt">str</span> <span class="op">{</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Hello, world!&quot;</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Insertable<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> warehouses<span class="at">)]</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> NewWarehouse <span class="op">{</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> location<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Insertable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> categories<span class="at">)]</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> NewCategory <span class="op">{</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> description<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Insertable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> products<span class="at">)]</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> NewProduct <span class="op">{</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> description<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> category_id<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">i32</span><span class="op">&gt;,</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Insertable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> administrators<span class="at">)]</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> NewAdministrator <span class="op">{</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> username<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> password<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> superuser<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span>Queryable<span class="op">,</span> Serialize<span class="op">,</span> Deserialize<span class="at">)]</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>diesel<span class="at">(</span>table_name <span class="op">=</span> warehouses<span class="at">)]</span></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> GetWarehouses <span class="op">{</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> location<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> updated_at<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>NaiveDateTime<span class="op">&gt;,</span></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="数据库连接函数">数据库连接函数</h4>
<p>调用后返回SqliteConnection结构,如果目标位置的嵌入式数据库文件不存在,则新建一个数据库.过程自动完成并且生成数据库所需的系统库嵌入到构建中.数据库连接函数只会在程序启动和初始化时使用,启动或初始化行为结束后即释放</p>
<pre><code>// 建立数据库连接

fn establish_connection() -&gt; SqliteConnection {

    let database_url = &quot;sqlite://./warehouse.db&quot;;

    SqliteConnection::establish(&amp;database_url)

        .expect(&amp;format!(&quot;Error connecting to {}&quot;, database_url))

}</code></pre>
<h4 id="一些初始化函数">一些初始化函数</h4>
<h5 id="数据迁移函数">数据迁移函数</h5>
<pre><code>async fn run_db_migrations(conn: &amp;mut SqliteConnection) {

    const MIGRATIONS: EmbeddedMigrations = embed_migrations!();

    if let Err(err) = conn.run_pending_migrations(MIGRATIONS) {

        error!(&quot;Error running migrations: {}&quot;, err);

    } else {

        info!(&quot;Database migrations executed successfully&quot;);

    }

}</code></pre>
<p>通过调用此函数,在应用启动时自动依据嵌入的数据库迁移文件来运行数据迁移</p>
<h5 id="本地节点初始化函数">本地节点初始化函数</h5>
<pre><code>// 获取名为&quot;ThisWarehouse&quot;的仓库ID MpHCXo8e0RfSru1kQQKoJawUgEUs9oYmktHPF+bT26o=

fn get_warehouse_id(

    conn: &amp;mut SqliteConnection,

) -&gt; Result&lt;ed25519::Keypair, diesel::result::Error&gt; {

    use self::warehouses::dsl::*;

    let warehouse: Warehouse = warehouses.filter(localkey.is_not_null()).first(conn)?;

    info!(&quot;Found warehouse: {:?}&quot;, warehouse.localkey);

    let mut local_key_bytes = if let Some(local_key) = &amp;warehouse.localkey {

        general_purpose::STANDARD

            .decode(local_key)

            .expect(&quot;Base64 decode error&quot;)

    } else {

        Vec::new() // 或者其他默认值的处理

    };

    let keypair =

        ed25519::Keypair::decode(local_key_bytes.as_mut_slice()).expect(&quot;Keypair decode error&quot;);

    Ok(keypair)

}

  

fn generate_and_insert_new_local_key(conn: &amp;mut SqliteConnection) -&gt; ed25519::Keypair {

    let local_key = ed25519::Keypair::generate();

    let local_key_base64 = general_purpose::STANDARD.encode(local_key.encode());

    info!(

        &quot;Generated and inserted new key {:?} for warehouse ThisWarehouse&quot;,

        local_key_base64

    );

    let local_peer_id = PeerId::from(PublicKey::Ed25519(local_key.public()));

    let new_warehouse = Warehouse {

        id: local_peer_id.to_string(),

        localkey: Some(local_key_base64),

        name: &quot;ThisWarehouse&quot;.to_string(),

        location: &quot;/ip4/127.0.0.1/tcp/8080&quot;.to_string(),

        created_at: Some(Utc::now().naive_utc()),

        updated_at: Some(Utc::now().naive_utc()),

    };

  

    use self::warehouses::dsl::*;

    diesel::insert_into(warehouses)

        .values(&amp;new_warehouse)

        .execute(conn)

        .expect(&quot;Error inserting new warehouse&quot;);

  

    local_key

}</code></pre>
<p>这里查找了数据库中本地节点的相关记录. 如果没有找到则会运行初始化</p>
<p>初始化过程包括生成ed25519密钥对,通过base64编码存入数据库本地节点记录中,从环境变量读取本地节点所在网络位置,存入数据库本地节点记录</p>
<p>程序启动时会读取密钥,依据公钥生成供其他节点认证的PeerID并打印到控制台,缓存私钥以供认证.</p>
<h5
id="本地节点superuser初始化的行为">本地节点superuser初始化的行为</h5>
<div class="sourceCode" id="cb14"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">rocket::</span>async_trait<span class="at">]</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> Fairing <span class="cf">for</span> AdminInit <span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Info <span class="op">{</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        Info <span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="st">&quot;Admin Initialization&quot;</span><span class="op">,</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            kind<span class="op">:</span> <span class="pp">Kind::</span>Ignite<span class="op">,</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> on_ignite(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> rocket<span class="op">:</span> Rocket<span class="op">&lt;</span>Build<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Rocket<span class="op">&lt;</span>Build<span class="op">&gt;,</span> Rocket<span class="op">&lt;</span>Build<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> db <span class="op">=</span> <span class="pp">DbConn::</span>get_one(<span class="op">&amp;</span>rocket)<span class="op">.</span><span class="kw">await</span><span class="op">.</span>expect(<span class="st">&quot;database connection&quot;</span>)<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        db<span class="op">.</span>run(<span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">self</span><span class="pp">::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin_count<span class="op">:</span> <span class="dt">i64</span> <span class="op">=</span> administrators</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>count()</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>get_result(c)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;Error counting admins&quot;</span>)<span class="op">;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin_count <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="kw">mut</span> random_password <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>from(<span class="st">&quot;111&quot;</span>)<span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                <span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>debug_assertions<span class="at">))]</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>                    random_password <span class="op">=</span> <span class="pp">rand::</span>thread_rng()</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>sample_iter(<span class="op">&amp;</span>Alphanumeric)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>take(<span class="dv">12</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>map(<span class="dt">char</span><span class="pp">::</span>from)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                <span class="pp">info!</span>(<span class="st">&quot;默认管理员已创建，用户名: admin, 密码: {}&quot;</span><span class="op">,</span> random_password)<span class="op">;</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>                <span class="pp">diesel::</span>insert_into(administrators)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>values((</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>                        username<span class="op">.</span>eq(<span class="st">&quot;admin&quot;</span>)<span class="op">,</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>                        password<span class="op">.</span>eq(random_password)<span class="op">,</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>                        superuser<span class="op">.</span>eq(<span class="cn">true</span>)<span class="op">,</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>                    ))</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>execute(c)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>expect(<span class="st">&quot;Error inserting admin&quot;</span>)<span class="op">;</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(rocket)</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>首次启动rocket会通过此行为生成默认管理员,身份为superuser,并把登录信息写入启动日志来供用户连接.在debug构建中密码为111,在非debug构建中会使用随机密码.</p>
<h4 id="路由功能的实现">路由功能的实现</h4>
<h5 id="登录和注册的options路由">登录和注册的options路由</h5>
<div class="sourceCode" id="cb15"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">rocket::</span>options<span class="at">(</span><span class="st">&quot;/login&quot;</span><span class="at">)]</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> options_login() <span class="op">-&gt;</span> Status <span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Status::</span><span class="cn">Ok</span> <span class="co">// 返回一个允许的状态码，如 200 OK</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">rocket::</span>options<span class="at">(</span><span class="st">&quot;/signup&quot;</span><span class="at">)]</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> options_signup() <span class="op">-&gt;</span> Status <span class="op">{</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Status::</span><span class="cn">Ok</span> <span class="co">// 返回一个允许的状态码，如 200 OK</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="测试用保护路由">测试用保护路由</h5>
<div class="sourceCode" id="cb16"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 受保护的路由</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>get<span class="at">(</span><span class="st">&quot;/protected&quot;</span><span class="at">)]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> protected_route(token<span class="op">:</span> JwtToken) <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">format!</span>(<span class="st">&quot;Hello, {}! This is a protected route.&quot;</span><span class="op">,</span> token<span class="op">.</span><span class="dv">0</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="各种功能路由">各种功能路由</h5>
<div class="sourceCode" id="cb17"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>get<span class="at">(</span><span class="st">&quot;/warehouses&quot;</span><span class="at">)]</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> get_warehouses(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>GetWarehouses<span class="op">&gt;&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>optional()</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> Json(CustomResponder<span class="op">{</span> status<span class="op">:</span><span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span> message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">}</span>))<span class="op">?;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder<span class="op">{</span> status<span class="op">:</span><span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span> message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">schema::warehouses::dsl::</span><span class="op">*;</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> warehouses</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>select((id<span class="op">,</span> name<span class="op">,</span> location<span class="op">,</span> created_at<span class="op">,</span> updated_at)) <span class="co">// 选择除去localkey之外的列</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="pp">load::</span><span class="op">&lt;</span>GetWarehouses<span class="op">&gt;</span>(c)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(Json)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;Error loading warehouses&quot;</span>)<span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(result)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="kw">await</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>post<span class="at">(</span><span class="st">&quot;/products&quot;</span><span class="op">,</span> format <span class="op">=</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span> data <span class="op">=</span> <span class="st">&quot;&lt;new_product&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> create_product(</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    new_product<span class="op">:</span> Json<span class="op">&lt;</span>NewProduct<span class="op">&gt;,</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span>NewProduct<span class="op">&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> db <span class="op">=</span> conn<span class="op">;</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_product <span class="op">=</span> db</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">crate</span><span class="pp">::schema::products::dsl::</span><span class="op">*;</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_product <span class="op">=</span> NewProduct <span class="op">{</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> new_product<span class="op">.</span>name<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> new_product<span class="op">.</span>description<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>                category_id<span class="op">:</span> new_product<span class="op">.</span>category_id<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>                updated_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> existing_product <span class="op">=</span> products</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(name<span class="op">.</span>eq(<span class="op">&amp;</span>new_product<span class="op">.</span>name))</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span><span class="bu">Product</span><span class="op">&gt;</span>(c)</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for product&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(_) <span class="op">=</span> existing_product <span class="op">{</span></span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>BadRequest<span class="op">,</span></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Product with this name already exists&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>            <span class="pp">diesel::</span>insert_into(products)</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>values(<span class="op">&amp;</span>new_product)</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>execute(c)</span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error inserting new product&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(Json(new_product))</span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">?;</span></span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(new_product)</span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>post<span class="at">(</span><span class="st">&quot;/categories&quot;</span><span class="op">,</span> format <span class="op">=</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span> data <span class="op">=</span> <span class="st">&quot;&lt;new_category&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> create_category(</span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a>    new_category<span class="op">:</span> Json<span class="op">&lt;</span>NewCategory<span class="op">&gt;,</span></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span>NewCategory<span class="op">&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> db <span class="op">=</span> conn<span class="op">;</span></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_category <span class="op">=</span> db</span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">crate</span><span class="pp">::schema::categories::dsl::</span><span class="op">*;</span></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_category <span class="op">=</span> NewCategory <span class="op">{</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> new_category<span class="op">.</span>name<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-254"><a href="#cb17-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> new_category<span class="op">.</span>description<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb17-258"><a href="#cb17-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-259"><a href="#cb17-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> existing_category <span class="op">=</span> categories</span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(name<span class="op">.</span>eq(<span class="op">&amp;</span>new_category<span class="op">.</span>name))</span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-265"><a href="#cb17-265" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Category<span class="op">&gt;</span>(c)</span>
<span id="cb17-266"><a href="#cb17-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-273"><a href="#cb17-273" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-274"><a href="#cb17-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for category&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(_) <span class="op">=</span> existing_category <span class="op">{</span></span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-286"><a href="#cb17-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-287"><a href="#cb17-287" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>BadRequest<span class="op">,</span></span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Category with this name already exists&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a>            <span class="pp">diesel::</span>insert_into(categories)</span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>values(<span class="op">&amp;</span>new_category)</span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>execute(c)</span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error inserting new category&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(Json(new_category))</span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">?;</span></span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(new_category)</span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>post<span class="at">(</span><span class="st">&quot;/warehouses&quot;</span><span class="op">,</span> format <span class="op">=</span> <span class="st">&quot;json&quot;</span><span class="op">,</span> data <span class="op">=</span> <span class="st">&quot;&lt;new_warehouse&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-328"><a href="#cb17-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-329"><a href="#cb17-329" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> create_warehouse(</span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a>    new_warehouse<span class="op">:</span> Json<span class="op">&lt;</span>NewWarehouse<span class="op">&gt;,</span></span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span>Warehouse<span class="op">&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> db <span class="op">=</span> conn<span class="op">;</span></span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_warehouse <span class="op">=</span> db</span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a>            <span class="kw">use</span> <span class="kw">self</span><span class="pp">::schema::warehouses::dsl::</span><span class="op">*;</span></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> existing_warehouse <span class="op">=</span> warehouses</span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(location<span class="op">.</span>eq(<span class="op">&amp;</span>new_warehouse<span class="op">.</span>location))</span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Warehouse<span class="op">&gt;</span>(c)</span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for warehouses&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(_) <span class="op">=</span> existing_warehouse <span class="op">{</span></span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>BadRequest<span class="op">,</span></span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Warehouse with this location already exists&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_warehouse <span class="op">=</span> Warehouse <span class="op">{</span></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a>                id<span class="op">:</span> new_warehouse<span class="op">.</span>id<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>                localkey<span class="op">:</span> <span class="cn">Some</span>(<span class="st">&quot;&quot;</span><span class="op">.</span>to_string())<span class="op">,</span></span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a>                name<span class="op">:</span> new_warehouse<span class="op">.</span>name<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>                location<span class="op">:</span> new_warehouse<span class="op">.</span>location<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a>                updated_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a>            <span class="pp">diesel::</span>insert_into(warehouses)</span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>values(<span class="op">&amp;</span>new_warehouse)</span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>execute(c)</span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error inserting new warehouse&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(Json(new_warehouse))</span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">?;</span></span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(new_warehouse)</span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>get<span class="at">(</span><span class="st">&quot;/products?&lt;start&gt;&amp;&lt;end&gt;&amp;&lt;categories_name&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> get_products(</span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a>    start<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a>    end<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>    categories_name<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="bu">Product</span><span class="op">&gt;&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">chrono::</span>NaiveDateTime<span class="op">;</span></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">diesel::prelude::</span><span class="op">*;</span></span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::categories::dsl::</span><span class="op">{</span>categories<span class="op">,</span> id <span class="kw">as</span> cat_id<span class="op">,</span> name <span class="kw">as</span> cat_name<span class="op">};</span></span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::products::dsl::</span><span class="op">{</span>category_id<span class="op">,</span> created_at<span class="op">,</span> products<span class="op">};</span></span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 解析start和end为NaiveDateTime</span></span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> start_dt <span class="op">=</span> <span class="pp">NaiveDateTime::</span>parse_from_str(<span class="op">&amp;</span>start<span class="op">,</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> end_dt <span class="op">=</span> <span class="pp">NaiveDateTime::</span>parse_from_str(<span class="op">&amp;</span>end<span class="op">,</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> results <span class="op">=</span> conn</span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-511"><a href="#cb17-511" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-512"><a href="#cb17-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-513"><a href="#cb17-513" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-514"><a href="#cb17-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-515"><a href="#cb17-515" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-516"><a href="#cb17-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-517"><a href="#cb17-517" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-518"><a href="#cb17-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-519"><a href="#cb17-519" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-520"><a href="#cb17-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-521"><a href="#cb17-521" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-522"><a href="#cb17-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-523"><a href="#cb17-523" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-524"><a href="#cb17-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-525"><a href="#cb17-525" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-526"><a href="#cb17-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-527"><a href="#cb17-527" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-528"><a href="#cb17-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-529"><a href="#cb17-529" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-530"><a href="#cb17-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-531"><a href="#cb17-531" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-532"><a href="#cb17-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-533"><a href="#cb17-533" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-534"><a href="#cb17-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-535"><a href="#cb17-535" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-536"><a href="#cb17-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-537"><a href="#cb17-537" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-538"><a href="#cb17-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-539"><a href="#cb17-539" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-540"><a href="#cb17-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-541"><a href="#cb17-541" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-542"><a href="#cb17-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-543"><a href="#cb17-543" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-544"><a href="#cb17-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-545"><a href="#cb17-545" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-546"><a href="#cb17-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-547"><a href="#cb17-547" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-548"><a href="#cb17-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-549"><a href="#cb17-549" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> query <span class="op">=</span> products</span>
<span id="cb17-550"><a href="#cb17-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-551"><a href="#cb17-551" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(created_at<span class="op">.</span>between(start_dt<span class="op">,</span> end_dt))</span>
<span id="cb17-552"><a href="#cb17-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-553"><a href="#cb17-553" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>into_boxed()<span class="op">;</span></span>
<span id="cb17-554"><a href="#cb17-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-555"><a href="#cb17-555" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-556"><a href="#cb17-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-557"><a href="#cb17-557" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 如果categories_name有值，添加分类名过滤条件</span></span>
<span id="cb17-558"><a href="#cb17-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-559"><a href="#cb17-559" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(cat_name_filter) <span class="op">=</span> categories_name <span class="op">{</span></span>
<span id="cb17-560"><a href="#cb17-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-561"><a href="#cb17-561" aria-hidden="true" tabindex="-1"></a>                query <span class="op">=</span> query<span class="op">.</span>filter(</span>
<span id="cb17-562"><a href="#cb17-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-563"><a href="#cb17-563" aria-hidden="true" tabindex="-1"></a>                    category_id<span class="op">.</span>eq_any(</span>
<span id="cb17-564"><a href="#cb17-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-565"><a href="#cb17-565" aria-hidden="true" tabindex="-1"></a>                        categories</span>
<span id="cb17-566"><a href="#cb17-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-567"><a href="#cb17-567" aria-hidden="true" tabindex="-1"></a>                            <span class="op">.</span>filter(cat_name<span class="op">.</span>eq(cat_name_filter))</span>
<span id="cb17-568"><a href="#cb17-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-569"><a href="#cb17-569" aria-hidden="true" tabindex="-1"></a>                            <span class="op">.</span>select(cat_id)<span class="op">,</span></span>
<span id="cb17-570"><a href="#cb17-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-571"><a href="#cb17-571" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">,</span></span>
<span id="cb17-572"><a href="#cb17-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-573"><a href="#cb17-573" aria-hidden="true" tabindex="-1"></a>                )<span class="op">;</span></span>
<span id="cb17-574"><a href="#cb17-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-575"><a href="#cb17-575" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-576"><a href="#cb17-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-577"><a href="#cb17-577" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-578"><a href="#cb17-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-579"><a href="#cb17-579" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(query<span class="op">.</span><span class="pp">load::</span><span class="op">&lt;</span><span class="bu">Product</span><span class="op">&gt;</span>(c)<span class="op">.</span>expect(<span class="st">&quot;Error loading warehouses&quot;</span>)) <span class="co">// 如果加载或转换过程中出现错误，抛出一个错误</span></span>
<span id="cb17-580"><a href="#cb17-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-581"><a href="#cb17-581" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-582"><a href="#cb17-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-583"><a href="#cb17-583" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb17-584"><a href="#cb17-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-585"><a href="#cb17-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-586"><a href="#cb17-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-587"><a href="#cb17-587" aria-hidden="true" tabindex="-1"></a>    results<span class="op">.</span>map(Json)</span>
<span id="cb17-588"><a href="#cb17-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-589"><a href="#cb17-589" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-590"><a href="#cb17-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-591"><a href="#cb17-591" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-592"><a href="#cb17-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-593"><a href="#cb17-593" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>get<span class="at">(</span><span class="st">&quot;/inventory?&lt;start&gt;&amp;&lt;end&gt;&amp;&lt;product_name&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-594"><a href="#cb17-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-595"><a href="#cb17-595" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> get_inventory(</span>
<span id="cb17-596"><a href="#cb17-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-597"><a href="#cb17-597" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-598"><a href="#cb17-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-599"><a href="#cb17-599" aria-hidden="true" tabindex="-1"></a>    start<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb17-600"><a href="#cb17-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-601"><a href="#cb17-601" aria-hidden="true" tabindex="-1"></a>    end<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb17-602"><a href="#cb17-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-603"><a href="#cb17-603" aria-hidden="true" tabindex="-1"></a>    product_name<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;,</span></span>
<span id="cb17-604"><a href="#cb17-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-605"><a href="#cb17-605" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-606"><a href="#cb17-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-607"><a href="#cb17-607" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Inventory<span class="op">&gt;&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-608"><a href="#cb17-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-609"><a href="#cb17-609" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">chrono::</span>NaiveDateTime<span class="op">;</span></span>
<span id="cb17-610"><a href="#cb17-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-611"><a href="#cb17-611" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">diesel::prelude::</span><span class="op">*;</span></span>
<span id="cb17-612"><a href="#cb17-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-613"><a href="#cb17-613" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-614"><a href="#cb17-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-615"><a href="#cb17-615" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-616"><a href="#cb17-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-617"><a href="#cb17-617" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::inventory::dsl::</span><span class="op">{</span>created_at<span class="op">,</span>inventory<span class="op">,</span> product_id<span class="op">};</span></span>
<span id="cb17-618"><a href="#cb17-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-619"><a href="#cb17-619" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::products::dsl::</span><span class="op">{</span>name <span class="kw">as</span> pro_name<span class="op">,</span> products<span class="op">};</span></span>
<span id="cb17-620"><a href="#cb17-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-621"><a href="#cb17-621" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-622"><a href="#cb17-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-623"><a href="#cb17-623" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 解析start和end为NaiveDateTime</span></span>
<span id="cb17-624"><a href="#cb17-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-625"><a href="#cb17-625" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> start_dt <span class="op">=</span> <span class="pp">NaiveDateTime::</span>parse_from_str(<span class="op">&amp;</span>start<span class="op">,</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb17-626"><a href="#cb17-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-627"><a href="#cb17-627" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> end_dt <span class="op">=</span> <span class="pp">NaiveDateTime::</span>parse_from_str(<span class="op">&amp;</span>end<span class="op">,</span> <span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb17-628"><a href="#cb17-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-629"><a href="#cb17-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-630"><a href="#cb17-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-631"><a href="#cb17-631" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> results <span class="op">=</span> conn</span>
<span id="cb17-632"><a href="#cb17-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-633"><a href="#cb17-633" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-634"><a href="#cb17-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-635"><a href="#cb17-635" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-636"><a href="#cb17-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-637"><a href="#cb17-637" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span><span class="op">.</span>clone()))</span>
<span id="cb17-638"><a href="#cb17-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-639"><a href="#cb17-639" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-640"><a href="#cb17-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-641"><a href="#cb17-641" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-642"><a href="#cb17-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-643"><a href="#cb17-643" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-644"><a href="#cb17-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-645"><a href="#cb17-645" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-646"><a href="#cb17-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-647"><a href="#cb17-647" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-648"><a href="#cb17-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-649"><a href="#cb17-649" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-650"><a href="#cb17-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-651"><a href="#cb17-651" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-652"><a href="#cb17-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-653"><a href="#cb17-653" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-654"><a href="#cb17-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-655"><a href="#cb17-655" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-656"><a href="#cb17-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-657"><a href="#cb17-657" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-658"><a href="#cb17-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-659"><a href="#cb17-659" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-660"><a href="#cb17-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-661"><a href="#cb17-661" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-662"><a href="#cb17-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-663"><a href="#cb17-663" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-664"><a href="#cb17-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-665"><a href="#cb17-665" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-666"><a href="#cb17-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-667"><a href="#cb17-667" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-668"><a href="#cb17-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-669"><a href="#cb17-669" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-670"><a href="#cb17-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-671"><a href="#cb17-671" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> query <span class="op">=</span> inventory</span>
<span id="cb17-672"><a href="#cb17-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-673"><a href="#cb17-673" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(created_at<span class="op">.</span>between(start_dt<span class="op">,</span> end_dt))</span>
<span id="cb17-674"><a href="#cb17-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-675"><a href="#cb17-675" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>into_boxed()<span class="op">;</span></span>
<span id="cb17-676"><a href="#cb17-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-677"><a href="#cb17-677" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-678"><a href="#cb17-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-679"><a href="#cb17-679" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(product_name_filter) <span class="op">=</span> <span class="op">&amp;</span>product_name <span class="op">{</span></span>
<span id="cb17-680"><a href="#cb17-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-681"><a href="#cb17-681" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 直接将 pro_id 的类型声明为 Integer 而不是 Nullable&lt;Integer&gt;</span></span>
<span id="cb17-682"><a href="#cb17-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-683"><a href="#cb17-683" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> subquery <span class="op">=</span> products</span>
<span id="cb17-684"><a href="#cb17-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-685"><a href="#cb17-685" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>filter(pro_name<span class="op">.</span>eq(product_name_filter))</span>
<span id="cb17-686"><a href="#cb17-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-687"><a href="#cb17-687" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>select(<span class="pp">sql::</span><span class="op">&lt;</span>Integer<span class="op">&gt;</span>(<span class="st">&quot;COALESCE(pro_id, 0)&quot;</span>))<span class="op">;</span></span>
<span id="cb17-688"><a href="#cb17-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-689"><a href="#cb17-689" aria-hidden="true" tabindex="-1"></a>                query <span class="op">=</span> query<span class="op">.</span>filter(product_id<span class="op">.</span>eq_any(subquery))<span class="op">;</span></span>
<span id="cb17-690"><a href="#cb17-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-691"><a href="#cb17-691" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-692"><a href="#cb17-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-693"><a href="#cb17-693" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-694"><a href="#cb17-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-695"><a href="#cb17-695" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(query</span>
<span id="cb17-696"><a href="#cb17-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-697"><a href="#cb17-697" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">load::</span><span class="op">&lt;</span>Inventory<span class="op">&gt;</span>(c)</span>
<span id="cb17-698"><a href="#cb17-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-699"><a href="#cb17-699" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;Error loading warehouses&quot;</span>)) <span class="co">// 如果加载或转换过程中出现错误，抛出一个错误</span></span>
<span id="cb17-700"><a href="#cb17-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-701"><a href="#cb17-701" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-702"><a href="#cb17-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-703"><a href="#cb17-703" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb17-704"><a href="#cb17-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-705"><a href="#cb17-705" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-706"><a href="#cb17-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-707"><a href="#cb17-707" aria-hidden="true" tabindex="-1"></a>    results<span class="op">.</span>map(Json)</span>
<span id="cb17-708"><a href="#cb17-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-709"><a href="#cb17-709" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-710"><a href="#cb17-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-711"><a href="#cb17-711" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-712"><a href="#cb17-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-713"><a href="#cb17-713" aria-hidden="true" tabindex="-1"></a><span class="co">// 登录接口</span></span>
<span id="cb17-714"><a href="#cb17-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-715"><a href="#cb17-715" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>post<span class="at">(</span><span class="st">&quot;/login&quot;</span><span class="op">,</span> data <span class="op">=</span> <span class="st">&quot;&lt;credentials&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-716"><a href="#cb17-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-717"><a href="#cb17-717" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> login(</span>
<span id="cb17-718"><a href="#cb17-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-719"><a href="#cb17-719" aria-hidden="true" tabindex="-1"></a>    credentials<span class="op">:</span> Json<span class="op">&lt;</span>LoginCredentials<span class="op">&gt;,</span></span>
<span id="cb17-720"><a href="#cb17-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-721"><a href="#cb17-721" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-722"><a href="#cb17-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-723"><a href="#cb17-723" aria-hidden="true" tabindex="-1"></a>    cookies<span class="op">:</span> <span class="op">&amp;</span>CookieJar<span class="op">&lt;</span><span class="ot">&#39;_</span><span class="op">&gt;,</span></span>
<span id="cb17-724"><a href="#cb17-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-725"><a href="#cb17-725" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-726"><a href="#cb17-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-727"><a href="#cb17-727" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-728"><a href="#cb17-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-729"><a href="#cb17-729" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-730"><a href="#cb17-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-731"><a href="#cb17-731" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> input_username <span class="op">=</span> credentials<span class="op">.</span>username<span class="op">.</span>clone()<span class="op">;</span> <span class="co">// 提取用户名</span></span>
<span id="cb17-732"><a href="#cb17-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-733"><a href="#cb17-733" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> input_password <span class="op">=</span> credentials<span class="op">.</span>password<span class="op">.</span>clone()<span class="op">;</span> <span class="co">// 提取密码，并用不同的变量名</span></span>
<span id="cb17-734"><a href="#cb17-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-735"><a href="#cb17-735" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-736"><a href="#cb17-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-737"><a href="#cb17-737" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> conn</span>
<span id="cb17-738"><a href="#cb17-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-739"><a href="#cb17-739" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-740"><a href="#cb17-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-741"><a href="#cb17-741" aria-hidden="true" tabindex="-1"></a>            administrators</span>
<span id="cb17-742"><a href="#cb17-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-743"><a href="#cb17-743" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(<span class="op">&amp;</span>input_username))</span>
<span id="cb17-744"><a href="#cb17-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-745"><a href="#cb17-745" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-746"><a href="#cb17-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-747"><a href="#cb17-747" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-748"><a href="#cb17-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-749"><a href="#cb17-749" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-750"><a href="#cb17-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-751"><a href="#cb17-751" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb17-752"><a href="#cb17-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-753"><a href="#cb17-753" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-754"><a href="#cb17-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-755"><a href="#cb17-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> result <span class="op">{</span></span>
<span id="cb17-756"><a href="#cb17-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-757"><a href="#cb17-757" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="cn">Some</span>(administrator)) <span class="cf">if</span> administrator<span class="op">.</span>password <span class="op">==</span> input_password <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb17-758"><a href="#cb17-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-759"><a href="#cb17-759" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> token <span class="op">=</span> generate_token(<span class="op">&amp;</span>administrator<span class="op">.</span>username)<span class="op">;</span></span>
<span id="cb17-760"><a href="#cb17-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-761"><a href="#cb17-761" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 将 token 存入 Cookie 中</span></span>
<span id="cb17-762"><a href="#cb17-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-763"><a href="#cb17-763" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> cookie<span class="op">:</span> Cookie <span class="op">=</span> <span class="pp">Cookie::</span>build((<span class="st">&quot;token&quot;</span><span class="op">,</span> token<span class="op">.</span>clone()))</span>
<span id="cb17-764"><a href="#cb17-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-765"><a href="#cb17-765" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>path(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb17-766"><a href="#cb17-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-767"><a href="#cb17-767" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>secure(<span class="cn">false</span>)</span>
<span id="cb17-768"><a href="#cb17-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-769"><a href="#cb17-769" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>http_only(<span class="cn">true</span>)</span>
<span id="cb17-770"><a href="#cb17-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-771"><a href="#cb17-771" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>build()<span class="op">;</span></span>
<span id="cb17-772"><a href="#cb17-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-773"><a href="#cb17-773" aria-hidden="true" tabindex="-1"></a>            cookies<span class="op">.</span>add(cookie)<span class="op">;</span></span>
<span id="cb17-774"><a href="#cb17-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-775"><a href="#cb17-775" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-776"><a href="#cb17-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-777"><a href="#cb17-777" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> <span class="pp">rocket::http::Status::</span><span class="cn">Ok</span><span class="op">,</span></span>
<span id="cb17-778"><a href="#cb17-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-779"><a href="#cb17-779" aria-hidden="true" tabindex="-1"></a>                message<span class="op">:</span> <span class="st">&quot;Success&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-780"><a href="#cb17-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-781"><a href="#cb17-781" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>))</span>
<span id="cb17-782"><a href="#cb17-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-783"><a href="#cb17-783" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-784"><a href="#cb17-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-785"><a href="#cb17-785" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-786"><a href="#cb17-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-787"><a href="#cb17-787" aria-hidden="true" tabindex="-1"></a>            status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-788"><a href="#cb17-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-789"><a href="#cb17-789" aria-hidden="true" tabindex="-1"></a>            message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-790"><a href="#cb17-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-791"><a href="#cb17-791" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>))<span class="op">,</span></span>
<span id="cb17-792"><a href="#cb17-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-793"><a href="#cb17-793" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-794"><a href="#cb17-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-795"><a href="#cb17-795" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-796"><a href="#cb17-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-797"><a href="#cb17-797" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-798"><a href="#cb17-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-799"><a href="#cb17-799" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>post<span class="at">(</span><span class="st">&quot;/signup&quot;</span><span class="op">,</span> data <span class="op">=</span> <span class="st">&quot;&lt;new_administrator&gt;&quot;</span><span class="at">)]</span></span>
<span id="cb17-800"><a href="#cb17-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-801"><a href="#cb17-801" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> signup(</span>
<span id="cb17-802"><a href="#cb17-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-803"><a href="#cb17-803" aria-hidden="true" tabindex="-1"></a>    new_administrator<span class="op">:</span> Json<span class="op">&lt;</span>NewAdministrator<span class="op">&gt;,</span></span>
<span id="cb17-804"><a href="#cb17-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-805"><a href="#cb17-805" aria-hidden="true" tabindex="-1"></a>    conn<span class="op">:</span> DbConn<span class="op">,</span></span>
<span id="cb17-806"><a href="#cb17-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-807"><a href="#cb17-807" aria-hidden="true" tabindex="-1"></a>    token<span class="op">:</span> JwtToken<span class="op">,</span></span>
<span id="cb17-808"><a href="#cb17-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-809"><a href="#cb17-809" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;,</span> Json<span class="op">&lt;</span>CustomResponder<span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb17-810"><a href="#cb17-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-811"><a href="#cb17-811" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">schema::administrators::dsl::</span><span class="op">*;</span></span>
<span id="cb17-812"><a href="#cb17-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-813"><a href="#cb17-813" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> input_username <span class="op">=</span> new_administrator<span class="op">.</span>username<span class="op">.</span>clone()<span class="op">;</span> <span class="co">// 提取用户名</span></span>
<span id="cb17-814"><a href="#cb17-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-815"><a href="#cb17-815" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> input_password <span class="op">=</span> new_administrator<span class="op">.</span>password<span class="op">.</span>clone()<span class="op">;</span> <span class="co">// 提取密码，并用不同的变量名</span></span>
<span id="cb17-816"><a href="#cb17-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-817"><a href="#cb17-817" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> input_superuser <span class="op">=</span> new_administrator<span class="op">.</span>superuser<span class="op">.</span>clone()<span class="op">;</span></span>
<span id="cb17-818"><a href="#cb17-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-819"><a href="#cb17-819" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> conn</span>
<span id="cb17-820"><a href="#cb17-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-821"><a href="#cb17-821" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>run(<span class="kw">move</span> <span class="op">|</span>c<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-822"><a href="#cb17-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-823"><a href="#cb17-823" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin <span class="op">=</span> administrators</span>
<span id="cb17-824"><a href="#cb17-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-825"><a href="#cb17-825" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(token<span class="op">.</span><span class="dv">0</span>))</span>
<span id="cb17-826"><a href="#cb17-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-827"><a href="#cb17-827" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(superuser<span class="op">.</span>eq(<span class="cn">true</span>))</span>
<span id="cb17-828"><a href="#cb17-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-829"><a href="#cb17-829" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-830"><a href="#cb17-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-831"><a href="#cb17-831" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-832"><a href="#cb17-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-833"><a href="#cb17-833" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-834"><a href="#cb17-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-835"><a href="#cb17-835" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-836"><a href="#cb17-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-837"><a href="#cb17-837" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>InternalServerError<span class="op">,</span></span>
<span id="cb17-838"><a href="#cb17-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-839"><a href="#cb17-839" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-840"><a href="#cb17-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-841"><a href="#cb17-841" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-842"><a href="#cb17-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-843"><a href="#cb17-843" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-844"><a href="#cb17-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-845"><a href="#cb17-845" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> admin<span class="op">.</span>is_none() <span class="op">{</span></span>
<span id="cb17-846"><a href="#cb17-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-847"><a href="#cb17-847" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-848"><a href="#cb17-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-849"><a href="#cb17-849" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-850"><a href="#cb17-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-851"><a href="#cb17-851" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Permission Denied&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-852"><a href="#cb17-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-853"><a href="#cb17-853" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-854"><a href="#cb17-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-855"><a href="#cb17-855" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-856"><a href="#cb17-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-857"><a href="#cb17-857" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> existing_admin <span class="op">=</span> administrators</span>
<span id="cb17-858"><a href="#cb17-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-859"><a href="#cb17-859" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(username<span class="op">.</span>eq(input_username<span class="op">.</span>clone()))</span>
<span id="cb17-860"><a href="#cb17-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-861"><a href="#cb17-861" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">first::</span><span class="op">&lt;</span>Administrator<span class="op">&gt;</span>(c)</span>
<span id="cb17-862"><a href="#cb17-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-863"><a href="#cb17-863" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>optional()</span>
<span id="cb17-864"><a href="#cb17-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-865"><a href="#cb17-865" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="op">{</span></span>
<span id="cb17-866"><a href="#cb17-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-867"><a href="#cb17-867" aria-hidden="true" tabindex="-1"></a>                    Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-868"><a href="#cb17-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-869"><a href="#cb17-869" aria-hidden="true" tabindex="-1"></a>                        status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>Unauthorized<span class="op">,</span></span>
<span id="cb17-870"><a href="#cb17-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-871"><a href="#cb17-871" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">:</span> <span class="st">&quot;Error checking for administrator&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-872"><a href="#cb17-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-873"><a href="#cb17-873" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)</span>
<span id="cb17-874"><a href="#cb17-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-875"><a href="#cb17-875" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">?;</span></span>
<span id="cb17-876"><a href="#cb17-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-877"><a href="#cb17-877" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(_) <span class="op">=</span> existing_admin <span class="op">{</span></span>
<span id="cb17-878"><a href="#cb17-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-879"><a href="#cb17-879" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-880"><a href="#cb17-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-881"><a href="#cb17-881" aria-hidden="true" tabindex="-1"></a>                    status<span class="op">:</span> <span class="pp">rocket::http::Status::</span>BadRequest<span class="op">,</span></span>
<span id="cb17-882"><a href="#cb17-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-883"><a href="#cb17-883" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">:</span> <span class="st">&quot;Administrator with this username already exists&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-884"><a href="#cb17-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-885"><a href="#cb17-885" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb17-886"><a href="#cb17-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-887"><a href="#cb17-887" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-888"><a href="#cb17-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-889"><a href="#cb17-889" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_administrator <span class="op">=</span> NewAdministrator <span class="op">{</span></span>
<span id="cb17-890"><a href="#cb17-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-891"><a href="#cb17-891" aria-hidden="true" tabindex="-1"></a>                username<span class="op">:</span> input_username<span class="op">,</span></span>
<span id="cb17-892"><a href="#cb17-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-893"><a href="#cb17-893" aria-hidden="true" tabindex="-1"></a>                password<span class="op">:</span> input_password<span class="op">,</span></span>
<span id="cb17-894"><a href="#cb17-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-895"><a href="#cb17-895" aria-hidden="true" tabindex="-1"></a>                superuser<span class="op">:</span> input_superuser<span class="op">,</span></span>
<span id="cb17-896"><a href="#cb17-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-897"><a href="#cb17-897" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-898"><a href="#cb17-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-899"><a href="#cb17-899" aria-hidden="true" tabindex="-1"></a>                updated_at<span class="op">:</span> <span class="cn">Some</span>(<span class="pp">Utc::</span>now()<span class="op">.</span>naive_utc())<span class="op">,</span></span>
<span id="cb17-900"><a href="#cb17-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-901"><a href="#cb17-901" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb17-902"><a href="#cb17-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-903"><a href="#cb17-903" aria-hidden="true" tabindex="-1"></a>            <span class="pp">diesel::</span>insert_into(administrators)</span>
<span id="cb17-904"><a href="#cb17-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-905"><a href="#cb17-905" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>values(<span class="op">&amp;</span>new_administrator)</span>
<span id="cb17-906"><a href="#cb17-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-907"><a href="#cb17-907" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>execute(c)</span>
<span id="cb17-908"><a href="#cb17-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-909"><a href="#cb17-909" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;Error inserting admin&quot;</span>)<span class="op">;</span></span>
<span id="cb17-910"><a href="#cb17-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-911"><a href="#cb17-911" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(Json(CustomResponder <span class="op">{</span></span>
<span id="cb17-912"><a href="#cb17-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-913"><a href="#cb17-913" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> <span class="pp">rocket::http::Status::</span><span class="cn">Ok</span><span class="op">,</span></span>
<span id="cb17-914"><a href="#cb17-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-915"><a href="#cb17-915" aria-hidden="true" tabindex="-1"></a>                message<span class="op">:</span> <span class="st">&quot;Administrator created&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb17-916"><a href="#cb17-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-917"><a href="#cb17-917" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>))</span>
<span id="cb17-918"><a href="#cb17-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-919"><a href="#cb17-919" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb17-920"><a href="#cb17-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-921"><a href="#cb17-921" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb17-922"><a href="#cb17-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-923"><a href="#cb17-923" aria-hidden="true" tabindex="-1"></a>    result</span>
<span id="cb17-924"><a href="#cb17-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-925"><a href="#cb17-925" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>路由中的数据库行为并不是通过上面的数据库连接函数实现的,而是rocket挂载的数据连接池.
路由的返回值为<code>Json&lt;CustomResponder&gt;</code>这一定制的结构体,包含了http请求状态和回应信息</p>
<h4 id="构建rocket">构建rocket</h4>
<div class="sourceCode" id="cb18"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">fn</span> rocket() <span class="op">-&gt;</span> Rocket<span class="op">&lt;</span>Build<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 从默认配置创建 Figment 实例</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> figment <span class="op">=</span> <span class="pp">Figment::</span>from(<span class="pp">Config::</span><span class="kw">default</span>())</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>merge((<span class="st">&quot;port&quot;</span><span class="op">,</span> <span class="dv">0</span>))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 合并自定义的数据库配置</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>merge(<span class="pp">Serialized::</span><span class="kw">default</span>(<span class="st">&quot;databases&quot;</span><span class="op">,</span> <span class="op">{</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> databases<span class="op">:</span> HashMap<span class="op">&lt;&amp;</span><span class="dt">str</span><span class="op">,</span> HashMap<span class="op">&lt;&amp;</span><span class="dt">str</span><span class="op">,</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">&gt;&gt;</span> <span class="op">=</span> <span class="pp">HashMap::</span>new()<span class="op">;</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> db_config<span class="op">:</span> HashMap<span class="op">&lt;&amp;</span><span class="dt">str</span><span class="op">,</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">&gt;</span> <span class="op">=</span> <span class="pp">HashMap::</span>new()<span class="op">;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            db_config<span class="op">.</span>insert(<span class="st">&quot;url&quot;</span><span class="op">,</span> <span class="st">&quot;sqlite://./warehouse.db&quot;</span>)<span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            databases<span class="op">.</span>insert(<span class="st">&quot;sqlite_db&quot;</span><span class="op">,</span> db_config)<span class="op">;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>            databases</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>))</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 合并环境变量配置，前缀为 &quot;APP_&quot;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>merge(<span class="pp">Env::</span>prefixed(<span class="st">&quot;APP_&quot;</span>))<span class="op">;</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 使用自定义的配置启动 Rocket 应用程序</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> rocket <span class="op">=</span> <span class="pp">rocket::</span>custom(figment)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 附加数据库连接</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>attach(<span class="pp">DbConn::</span>fairing())</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">//执行用于网页认证的管理员初始化</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>attach(AdminInit)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 挂载路由</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mount(<span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="pp">routes!</span>[index])</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>mount(</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/api&quot;</span><span class="op">,</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>            <span class="pp">routes!</span>[</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>                get_warehouses<span class="op">,</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>                create_warehouse<span class="op">,</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>                create_category<span class="op">,</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>                create_product<span class="op">,</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>                get_products<span class="op">,</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>                login<span class="op">,</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>                options_login<span class="op">,</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>                protected_route<span class="op">,</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>                signup<span class="op">,</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>                options_signup</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">,</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span><span class="co">//挂载路由</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 只在 debug 模式下启用 CORS 配置</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>debug_assertions<span class="at">)]</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cors <span class="op">=</span> <span class="pp">CorsOptions::</span><span class="kw">default</span>()</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>allowed_origins(<span class="pp">AllowedOrigins::</span>all())</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>allowed_methods(</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>                <span class="pp">vec!</span>[</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Method::</span>Get<span class="op">,</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Method::</span>Post<span class="op">,</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// 还可以添加其它允许的方法，如 Method::Put, Method::Delete 等</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>into_iter()</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map(<span class="bu">From</span><span class="pp">::</span>from)</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span>HashSet<span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">,</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>allowed_headers(<span class="pp">AllowedHeaders::</span>all())</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>allow_credentials(<span class="cn">true</span>)</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>to_cors()</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>        rocket <span class="op">=</span> rocket<span class="op">.</span>attach(cors)<span class="op">;</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>    rocket</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>在debug构建中使用跨域资源共享来方便调试,在release构建中关闭来加强安全性.
使用figment嵌入式配置来配置连接池,端口等配置</p>
</blockquote>
<h4 id="main函数">main函数</h4>
<pre><code>#[tokio::main]

async fn main() -&gt; StdResult&lt;(), Box&lt;dyn Error&gt;&gt; {

    // 获取当前时间并格式化为文件名

    let now = Local::now();

    let log_file_name = format!(&quot;log/output_{}.log&quot;, now.format(&quot;%Y-%m-%d_%H-%M-%S&quot;));

  

    // 构建文件 appender

    let file_appender = FileAppender::builder()

        .encoder(Box::new(PatternEncoder::new(&quot;{d} - {l} - {m}{n}&quot;)))

        .build(log_file_name)

        .unwrap();

  

    // 构建 console appender

    let console_appender = ConsoleAppender::builder()

        .encoder(Box::new(PatternEncoder::new(&quot;{d} - {l} - {m}{n}&quot;)))

        .build();

  

    // 创建 root 配置

    let logconfig = LogConfig::builder()

        .appender(Appender::builder().build(&quot;stdout&quot;, Box::new(console_appender)))

        .appender(Appender::builder().build(&quot;file&quot;, Box::new(file_appender)))

        .build(

            Root::builder()

                .appender(&quot;stdout&quot;)

                .appender(&quot;file&quot;)

                .build(LevelFilter::Info),

        )

        .unwrap();

  

    // 初始化 log4rs 配置

    init_config(logconfig).unwrap();

  

    // 创建本地PeerId

    let mut connection = establish_connection();

    run_db_migrations(&amp;mut connection).await;

    let local_key = match get_warehouse_id(&amp;mut connection) {

        Ok(id) =&gt; id,

        Err(err) =&gt; {

            error!(&quot;Failed to get warehouse local key: {}&quot;, err);

            generate_and_insert_new_local_key(&amp;mut connection)

        }

    };

  

    let local_peer_id = PeerId::from(PublicKey::Ed25519(local_key.public()));

    info!(&quot;Local peer id: {:?}&quot;, local_peer_id);

    let floodsub = Floodsub::new(local_peer_id.clone());

    // 创建传输层

    let transport = development_transport(libp2p::identity::Keypair::Ed25519(local_key)).await?;

  

    // 创建Kademlia DHT

    let store = MemoryStore::new(local_peer_id.clone());

    let kademlia_config = KademliaConfig::default();

    let kademlia = Kademlia::with_config(local_peer_id.clone(), store, kademlia_config);

  

    // 创建mDNS

    let mdns = Mdns::new(MdnsConfig::default()).await?;

  

    let ping = Ping::new(PingConfig::new().with_keep_alive(true));

  

    // 创建网络行为

    let behaviour = KMBehaviour {

        kademlia,

        mdns,

        ping,

        floodsub,

    };

  

    // 构建Swarm

    let mut swarm = SwarmBuilder::new(transport, behaviour, local_peer_id)

        .executor(Box::new(|fut| {

            tokio::spawn(fut);

        }))

        .build();

  

    let topic = Topic::new(&quot;dev&quot;);

    // 获取环境变量中的 bootstrap_peer_id

    let bootstrap_peer_id_str = match env::var(&quot;BOOTSTRAP_PEER_ID&quot;) {

        Ok(val) =&gt; {

            info!(&quot;Find BOOTSTRAP_PEER_ID {:?}&quot;, val);

            val

        }

        Err(_) =&gt; {

            warn!(&quot;Warning: BOOTSTRAP_PEER_ID environment variable is not set&quot;);

            PeerId::from_public_key(&amp;identity::PublicKey::Ed25519(

                identity::ed25519::PublicKey::decode(&amp;[0u8; 32]).unwrap(),

            ))

            .to_string()

        }

    };

  

    // 获取环境变量中的 bootstrap_addr

    let bootstrap_addr_str = match env::var(&quot;BOOTSTRAP_ADDR&quot;) {

        Ok(val) =&gt; {

            info!(&quot;Find BOOTSTRAP_ADDR {:?}&quot;, val);

            val

        }

        Err(_) =&gt; {

            warn!(&quot;Warning: BOOTSTRAP_ADDR environment variable is not set&quot;);

            &quot;/ip4/127.0.0.1/tcp/8080&quot;.to_string()

        }

    };

    // 获取环境变量中的 listening_addr_str

    let listening_addr_str = match env::var(&quot;LISTENING_ADDR&quot;) {

        Ok(val) =&gt; {

            info!(&quot;Find LISTENING_ADDR {:?}&quot;, val);

            val

        }

        Err(_) =&gt; {

            warn!(&quot;Warning: LISTENING_ADDR environment variable is not set, using default value:/ip4/0.0.0.0/tcp/12345&quot;);

            &quot;/ip4/0.0.0.0/tcp/12345&quot;.to_string()

        }

    };

    // 添加引导节点

    let bootstrap_peer_id = bootstrap_peer_id_str.parse::&lt;PeerId&gt;()?;

    let bootstrap_addr: Multiaddr = bootstrap_addr_str.parse().unwrap();

  

    match env::var_os(&quot;BOOTSTRAP_ADDR&quot;) {

        Some(addr_value) =&gt; {

            info!(&quot;find BOOTSTRAP_ADDR {:?}&quot;, addr_value);

            match env::var_os(&quot;BOOTSTRAP_PEER_ID&quot;) {

                Some(id_value) =&gt; {

                    info!(

                        &quot;via {:?} discover node which peer id is {:?}&quot;,

                        addr_value, id_value

                    );

                    swarm

                        .behaviour_mut()

                        .kademlia

                        .add_address(&amp;bootstrap_peer_id, bootstrap_addr);

                }

                None =&gt; {

                    warn!(&quot;BOOTSTRAP_PEER_ID environment variable is not set,run as bootstrap node&quot;)

                }

            }

        }

        None =&gt; warn!(&quot;BOOTSTRAP_ADDR environment variable is not set,run as bootstrap node&quot;),

    }

    // 设置监听地址

    let listen_addr: Multiaddr = env::var(&quot;LISTEN_ADDR&quot;)

        .unwrap_or_else(|_| listening_addr_str.to_string())

        .parse()

        .unwrap();

    Swarm::behaviour_mut(&amp;mut swarm)

        .floodsub

        .subscribe(topic.clone());

  

    Swarm::listen_on(&amp;mut swarm, listen_addr)?;

  

    let rocket_handle = task::spawn(async {

        let rocket = rocket().await;

        rocket.launch().await.unwrap();

    });

  

    let swarm_handle = task::spawn(async move {

        let mut discovered_peers = HashSet::new();

        let mut stdin = io::BufReader::new(io::stdin()).compat().lines();

        loop {

            tokio::select! {

                    line = stdin.next() =&gt; {

                        match line {

                            Some(Ok(line)) =&gt; {

                                let _ = swarm.behaviour_mut().floodsub.publish(topic.clone(), line.as_bytes());

                                info!(&quot;floodsub {:?} publish: {:?}&quot;, topic.clone(), line);

                            }

                            Some(Err(e)) =&gt; {

                                info!(&quot;Error reading from stdin: {:?}&quot;, e);

                            }

                            None =&gt; break, // EOF reached

                        }

                    }

                    event = swarm.next() =&gt; {

                        match event {

                            Some(event) =&gt; match event {

                                SwarmEvent::Behaviour(KMBehaviourEvent::Mdns(MdnsEvent::Discovered(peers))) =&gt; {

                                    for (peer_id, _) in peers {

                                        if discovered_peers.insert(peer_id.clone()) {

                                            info!(&quot;Discovered peer via mDNS: {:?}&quot;, peer_id);

                                            if let Err(e) = swarm.dial(peer_id.clone()) {

                                                info!(&quot;Failed to dial discovered peer: {:?}&quot;, e);

                                            }

                                        }

                                    }

                                }

                                SwarmEvent::Behaviour(KMBehaviourEvent::Mdns(MdnsEvent::Expired(peers))) =&gt; {

                                    for (peer_id, _) in peers {

                                        info!(&quot;Expired peer via mDNS: {:?}&quot;, peer_id);

                                    }

                                }

                                SwarmEvent::Behaviour(KMBehaviourEvent::Kademlia(

                                    KademliaEvent::RoutingUpdated { peer, .. },

                                )) =&gt; {

                                    if discovered_peers.insert(peer.clone()) {

                                        info!(&quot;Discovered peer via Kademlia: {:?}&quot;, peer);

                                        if let Err(e) = swarm.dial(peer) {

                                            info!(&quot;Failed to dial discovered peer: {:?}&quot;, e);

                                        }

                                    }

                                }

                                SwarmEvent::ConnectionEstablished { peer_id, .. } =&gt; {

                                    info!(&quot;Connected to peer: {:?}&quot;, peer_id);

                                }

                                SwarmEvent::ConnectionClosed { peer_id, cause, .. } =&gt; {

                                    if let Some(err) = cause {

                                        info!(

                                            &quot;Connection to peer {:?} closed with error: {:?}&quot;,

                                            peer_id, err

                                        );

                                    } else {

                                        info!(&quot;Connection to peer {:?} closed.&quot;, peer_id);

                                    }

                                }

                                SwarmEvent::Behaviour(KMBehaviourEvent::Ping(event)) =&gt; {

                                    info!(&quot;Ping: {:?}&quot;, event);

                                }

                                SwarmEvent::Behaviour(KMBehaviourEvent::Floodsub(FloodsubEvent::Message(message))) =&gt; {

                                    info!(&quot;Received: &#39;{:?}&#39; from {:?}&quot;, String::from_utf8_lossy(&amp;message.data), message.source);

                                }

                                _ =&gt; { }

                            },

                            None =&gt; break, // Swarm event stream ended

                        }

                    }

            }

        }

    });

  

    let mut rocket_handle = Some(rocket_handle);

    let mut swarm_handle = Some(swarm_handle);

  

    // 处理 SIGINT 信号

    tokio::select! {

        _ = signal::ctrl_c() =&gt; {

            warn!(&quot;Received shutdown signal, shutting down...&quot;);

        }

        _ = async { if let Some(handle) = rocket_handle.take() { handle.await.unwrap(); } } =&gt; {

            info!(&quot;Rocket task completed.&quot;);

        }

        _ = async { if let Some(handle) = swarm_handle.take() { handle.await.unwrap(); } } =&gt; {

            info!(&quot;Swarm task completed.&quot;);

        }

    }

  

    info!(&quot;Waiting for tasks to finish...&quot;);

    if let Some(handle) = rocket_handle {

        handle.await?;

    }

    if let Some(handle) = swarm_handle {

        handle.await?;

    }

  

    Ok(())

}</code></pre>
<p>main函数使用了tokio异步处理.并在内部启动了两个独立的异步任务来处理两个阻塞性任务.p2p网络行为的loop和rocket监听.</p>
<p>在main中首先生成日志配置,监理日志记录文件,设置日志等级,初始化日志记录器</p>
<p>设定了两个日志记录器,终端和日志文件.</p>
<p>然后依据启动和初始化函数中获取的记录和环境变量初始化本地节点身份和监听端口.构建网络行为</p>
<p>然后启动了两个独立的异步任务来分别处理网络行为和rocket.</p>
<p>最后实现退出逻辑.</p>
<h1 id="前端">前端</h1>
<h2 id="前端重点">前端重点</h2>
<ul>
<li>界面美观</li>
<li>远程访问方便</li>
<li>操作人性化</li>
<li>不同软件,平台和设备类型的兼容性优良</li>
<li>响应迅速</li>
<li>本地化</li>
</ul>
<h2
id="使用react构建的前端部分未完成">使用React构建的前端(部分未完成)</h2>
<p>通过编写和组织不同模块来丰富功能,同时也保证了可读性,方便维护和扩展.
通过framer-motion, nextui, antd等库来优化使用体验</p>
<p>代码就省略了</p>
<p>构建后通过rocket嵌入部署,安全且部署便捷.</p>
</body>
</html>